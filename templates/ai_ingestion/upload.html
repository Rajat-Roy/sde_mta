{% extends 'base.html' %}

{% block title %}Upload Product - District Marketplace{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">List Your Product</h1>
    <p class="lead">Upload your product using voice, image, or text. Our AI will automatically extract product details!</p>

    <div class="row mt-5">
        <!-- Text Input -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h3 class="card-title">üìù Text Input</h3>
                    <p class="card-text">Describe your product in text</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#textModal">Enter Text</button>
                </div>
            </div>
        </div>

        <!-- Image Upload -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h3 class="card-title">üì∏ Image Upload</h3>
                    <p class="card-text">Upload product photos</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#imageModal">Upload Image</button>
                </div>
            </div>
        </div>

        <!-- Voice Input -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h3 class="card-title">üé§ Voice Input</h3>
                    <p class="card-text">Describe by speaking</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#voiceModal">Record Voice</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Jobs -->
    <div class="mt-5">
        <h3>Recent Uploads</h3>
        <div id="recent-jobs"></div>
    </div>
</div>

<!-- Text Input Modal -->
<div class="modal fade" id="textModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Describe Your Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="textForm">
                    <div class="mb-3">
                        <label class="form-label">Product Description</label>
                        <textarea class="form-control" id="productText" rows="5" placeholder="Example: Fresh organic tomatoes, 5kg available, Rs. 100 per kg, grown locally without pesticides" required></textarea>
                        <small class="form-text text-muted">Include: product name, quantity, price, and any special details</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Fetch Details</button>
                </form>
                <div id="textResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Image Upload Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Product Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="imageForm">
                    <div class="mb-3">
                        <label class="form-label">Product Image</label>
                        <input type="file" class="form-control" id="productImage" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Description (Optional)</label>
                        <textarea class="form-control" id="imageText" rows="3" placeholder="Add any extra details..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload & Process</button>
                </form>
                <div id="imageResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Voice Input Modal -->
<div class="modal fade" id="voiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Voice Input</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p>Click the microphone button and describe your product:</p>
                    <div class="text-center mb-3">
                        <button type="button" id="voiceButton" class="btn btn-lg btn-primary">
                            <span id="voiceIcon">üé§</span> <span id="voiceStatus">Start Recording</span>
                        </button>
                    </div>
                    <div id="voiceSupport" class="alert alert-warning" style="display:none;">
                        Voice recognition is not supported in your browser. Please use Chrome, Edge, or Safari.
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Transcribed Text:</label>
                    <textarea class="form-control" id="voiceTranscript" rows="5" readonly></textarea>
                </div>
                <button type="button" id="voiceSubmit" class="btn btn-primary" disabled>Submit Product</button>
                <div id="voiceResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Product Details Preview Modal -->
<div class="modal fade" id="productPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Review & Edit Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Extracting details...</span>
                    </div>
                    <p class="mt-3">Analyzing product and fetching details from web...</p>
                </div>

                <div id="previewForm" style="display:none;">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-3">Product Information</h6>
                            <div class="mb-3">
                                <label class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="preview_name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="preview_description" rows="4"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Price (‚Çπ)</label>
                                    <input type="number" class="form-control" id="preview_price" step="0.01" min="0">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="preview_quantity" min="1" value="1">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Unit</label>
                                    <input type="text" class="form-control" id="preview_unit" value="piece">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" id="preview_category">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-3">Product Images</h6>

                            <!-- Upload custom image -->
                            <div class="mb-3">
                                <label class="form-label">Upload Your Own Images</label>
                                <input type="file" class="form-control" id="customImageUpload" accept="image/*" multiple>
                                <small class="text-muted">Upload up to 3 images</small>
                            </div>

                            <hr>

                            <!-- Scraped images -->
                            <h6 class="mb-2">Or Select from Web</h6>
                            <div id="imagePreviewGrid" class="d-grid gap-2" style="max-height: 300px; overflow-y: auto;">
                                <!-- Image checkboxes will be inserted here -->
                            </div>
                            <small class="text-muted">Select up to 3 images total</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="createProductBtn" class="btn btn-primary" style="display:none;">Create Product</button>
            </div>
        </div>
    </div>
</div>

<script>
// Get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Check if user is logged in (simple check)
function checkAuth() {
    // In a real app, you'd check session/token
    // For now, we'll just show a message if not authenticated
    return true; // You can implement proper auth check here
}

// Voice Recognition Setup
let recognition;
let isRecording = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    let finalTranscript = '';

    recognition.onresult = (event) => {
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
            } else {
                interimTranscript += transcript;
            }
        }

        document.getElementById('voiceTranscript').value = finalTranscript + interimTranscript;

        if (finalTranscript.length > 0) {
            document.getElementById('voiceSubmit').disabled = false;
        }
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isRecording = false;
        document.getElementById('voiceIcon').textContent = 'üé§';
        document.getElementById('voiceStatus').textContent = 'Start Recording';
        document.getElementById('voiceButton').classList.remove('btn-danger');
        document.getElementById('voiceButton').classList.add('btn-primary');
    };

    recognition.onend = () => {
        isRecording = false;
        document.getElementById('voiceIcon').textContent = 'üé§';
        document.getElementById('voiceStatus').textContent = 'Start Recording';
        document.getElementById('voiceButton').classList.remove('btn-danger');
        document.getElementById('voiceButton').classList.add('btn-primary');
    };

    document.getElementById('voiceButton').addEventListener('click', () => {
        if (!isRecording) {
            finalTranscript = '';
            document.getElementById('voiceTranscript').value = '';
            recognition.start();
            isRecording = true;
            document.getElementById('voiceIcon').textContent = '‚èπÔ∏è';
            document.getElementById('voiceStatus').textContent = 'Stop Recording';
            document.getElementById('voiceButton').classList.remove('btn-primary');
            document.getElementById('voiceButton').classList.add('btn-danger');
        } else {
            recognition.stop();
            isRecording = false;
        }
    });

    document.getElementById('voiceSubmit').addEventListener('click', async () => {
        const text = document.getElementById('voiceTranscript').value;
        const resultDiv = document.getElementById('voiceResult');

        if (!text) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Please record some voice input first.</div>';
            return;
        }

        resultDiv.innerHTML = '<div class="alert alert-info">Processing voice input...</div>';

        try {
            const response = await fetch('/ingest/api/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    input_type: 'text', // We send transcribed text as text input
                    text: text
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Success!</strong> Product created!
                        <br><small>Product: ${data.product_name}</small>
                        <br><small>Processing time: ${data.processing_time}s</small>
                    </div>
                    <a href="/products/${data.product_id}/" class="btn btn-sm btn-primary">View Product</a>
                `;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Failed to create product'}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });
} else {
    // Show warning if speech recognition not supported
    document.getElementById('voiceSupport').style.display = 'block';
    document.getElementById('voiceButton').disabled = true;
}

// Global state for extracted data
let selectedImages = [];
let extractedData = {};

// Text form submission - fetch and preview details
document.getElementById('textForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = document.getElementById('productText').value;

    // Close text modal and show preview modal with loading
    const textModal = bootstrap.Modal.getInstance(document.getElementById('textModal'));
    textModal.hide();

    const previewModal = new bootstrap.Modal(document.getElementById('productPreviewModal'));
    previewModal.show();

    // Show loading state
    document.getElementById('previewLoading').style.display = 'block';
    document.getElementById('previewForm').style.display = 'none';
    document.getElementById('createProductBtn').style.display = 'none';

    try {
        // Extract product details
        const response = await fetch('/ingest/api/extract/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            credentials: 'same-origin',
            body: JSON.stringify({ text: text })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            extractedData = data.extracted_data;
            selectedImages = [];

            // Populate form fields
            document.getElementById('preview_name').value = extractedData.name || '';
            document.getElementById('preview_description').value = extractedData.description || '';
            document.getElementById('preview_price').value = extractedData.price || 0;
            document.getElementById('preview_quantity').value = extractedData.quantity || 1;
            document.getElementById('preview_unit').value = extractedData.unit || 'piece';
            document.getElementById('preview_category').value = extractedData.category || 'Uncategorized';

            // Show images
            const imageGrid = document.getElementById('imagePreviewGrid');
            imageGrid.innerHTML = '';

            if (data.image_urls && data.image_urls.length > 0) {
                data.image_urls.forEach((url, idx) => {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'form-check';
                    imgDiv.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${url}" id="preview_img_${idx}">
                        <label class="form-check-label d-flex align-items-center" for="preview_img_${idx}">
                            <img src="${url}" style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px;"
                                 onerror="this.parentElement.parentElement.style.display='none'">
                            <span>Image ${idx + 1}</span>
                        </label>
                    `;
                    imageGrid.appendChild(imgDiv);

                    // Add event listener for image selection (max 3)
                    imgDiv.querySelector('input').addEventListener('change', function() {
                        if (this.checked) {
                            if (selectedImages.length >= 3) {
                                this.checked = false;
                                alert('You can select up to 3 images only.');
                                return;
                            }
                            selectedImages.push(this.value);
                        } else {
                            selectedImages = selectedImages.filter(img => img !== this.value);
                        }
                    });
                });
            } else {
                imageGrid.innerHTML = '<p class="text-muted">No images found</p>';
            }

            // Hide loading, show form
            document.getElementById('previewLoading').style.display = 'none';
            document.getElementById('previewForm').style.display = 'block';
            document.getElementById('createProductBtn').style.display = 'block';

        } else {
            alert('Error: ' + (data.error || 'Failed to extract details'));
            previewModal.hide();
        }

    } catch (error) {
        alert('Error: ' + error.message);
        previewModal.hide();
    }
});

// Create product button handler
document.getElementById('createProductBtn').addEventListener('click', async () => {
    const previewModal = bootstrap.Modal.getInstance(document.getElementById('productPreviewModal'));
    const createBtn = document.getElementById('createProductBtn');

    // Disable button and show processing
    createBtn.disabled = true;
    createBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

    try {
        // Check if using custom uploaded images or scraped images
        const uploadedFiles = document.getElementById('customImageUpload').files;

        if (uploadedFiles.length > 0) {
            // Use FormData for file upload
            const formData = new FormData();
            formData.append('input_type', 'text');
            formData.append('text', document.getElementById('productText').value);
            formData.append('product_name', document.getElementById('preview_name').value);
            formData.append('product_description', document.getElementById('preview_description').value);
            formData.append('product_price', parseFloat(document.getElementById('preview_price').value) || 0);
            formData.append('product_quantity', parseInt(document.getElementById('preview_quantity').value) || 1);
            formData.append('product_unit', document.getElementById('preview_unit').value);
            formData.append('product_category', document.getElementById('preview_category').value);

            // Add uploaded files (max 3)
            for (let i = 0; i < Math.min(uploadedFiles.length, 3); i++) {
                formData.append('uploaded_images', uploadedFiles[i]);
            }

            const response = await fetch('/ingest/api/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                credentials: 'same-origin',
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.success) {
                previewModal.hide();
                alert(`Product created successfully!\nProduct: ${data.product_name}\nProcessing time: ${data.processing_time}s`);
                window.location.href = `/products/${data.product_id}/`;
            } else {
                alert('Error: ' + (data.error || 'Failed to create product'));
                createBtn.disabled = false;
                createBtn.innerHTML = 'Create Product';
            }

        } else {
            // Use JSON for scraped images
            const productData = {
                input_type: 'text',
                text: document.getElementById('productText').value,
                selected_image_urls: selectedImages,
                product_name: document.getElementById('preview_name').value,
                product_description: document.getElementById('preview_description').value,
                product_price: parseFloat(document.getElementById('preview_price').value) || 0,
                product_quantity: parseInt(document.getElementById('preview_quantity').value) || 1,
                product_unit: document.getElementById('preview_unit').value,
                product_category: document.getElementById('preview_category').value
            };

            const response = await fetch('/ingest/api/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                credentials: 'same-origin',
                body: JSON.stringify(productData)
            });

            const data = await response.json();

            if (response.ok && data.success) {
                previewModal.hide();
                alert(`Product created successfully!\nProduct: ${data.product_name}\nProcessing time: ${data.processing_time}s`);
                window.location.href = `/products/${data.product_id}/`;
            } else {
                alert('Error: ' + (data.error || 'Failed to create product'));
                createBtn.disabled = false;
                createBtn.innerHTML = 'Create Product';
            }
        }

    } catch (error) {
        alert('Error: ' + error.message);
        createBtn.disabled = false;
        createBtn.innerHTML = 'Create Product';
    }
});

// Show image selection modal with fetched images (deprecated - now using preview modal)
function showImageSelectionModal(previewData) {
    const modal = new bootstrap.Modal(document.getElementById('imageSelectionModal'));
    const loadingDiv = document.getElementById('imageSelectionLoading');
    const gridDiv = document.getElementById('imageSelectionGrid');
    const errorDiv = document.getElementById('imageSelectionError');

    selectedImages = [];

    if (previewData.success && previewData.image_urls && previewData.image_urls.length > 0) {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        gridDiv.style.display = 'flex';
        gridDiv.innerHTML = '';

        previewData.image_urls.forEach((url, index) => {
            const imageCard = document.createElement('div');
            imageCard.className = 'col-md-4 col-sm-6';
            imageCard.innerHTML = `
                <div class="card image-selection-card" data-url="${url}" data-index="${index}">
                    <img src="${url}" class="card-img-top" alt="Product image ${index + 1}"
                         style="height: 200px; object-fit: cover; cursor: pointer;"
                         onerror="this.parentElement.style.display='none'">
                    <div class="card-body p-2 text-center">
                        <div class="form-check">
                            <input class="form-check-input image-checkbox" type="checkbox"
                                   id="img-${index}" data-url="${url}">
                            <label class="form-check-label" for="img-${index}">
                                Select
                            </label>
                        </div>
                    </div>
                </div>
            `;
            gridDiv.appendChild(imageCard);
        });

        // Add click handlers for image selection
        document.querySelectorAll('.image-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', handleImageSelection);
        });

    } else {
        loadingDiv.style.display = 'none';
        gridDiv.style.display = 'none';
        errorDiv.style.display = 'block';
    }

    modal.show();
}

// Handle image selection with max 3 images
function handleImageSelection(event) {
    const checkbox = event.target;
    const url = checkbox.dataset.url;

    if (checkbox.checked) {
        if (selectedImages.length >= 3) {
            checkbox.checked = false;
            alert('You can select up to 3 images only.');
            return;
        }
        selectedImages.push(url);
    } else {
        selectedImages = selectedImages.filter(img => img !== url);
    }
}

// Confirm image selection and create product
document.getElementById('confirmImageSelection').addEventListener('click', async () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById('imageSelectionModal'));
    modal.hide();

    // Show text modal again with processing status
    const textModal = new bootstrap.Modal(document.getElementById('textModal'));
    textModal.show();

    const resultDiv = document.getElementById('textResult');
    resultDiv.innerHTML = '<div class="alert alert-info">Creating product with selected images...</div>';

    try {
        const response = await fetch('/ingest/api/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                input_type: 'text',
                text: currentProductText,
                selected_image_urls: selectedImages
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>Success!</strong> Product created!
                    <br><small>Product: ${data.product_name}</small>
                    <br><small>Selected ${selectedImages.length} image(s)</small>
                    <br><small>Processing time: ${data.processing_time}s</small>
                </div>
                <a href="/products/${data.product_id}/" class="btn btn-sm btn-primary">View Product</a>
            `;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Failed to create product'}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
});

// Image form submission (not yet implemented)
document.getElementById('imageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const resultDiv = document.getElementById('imageResult');
    resultDiv.innerHTML = '<div class="alert alert-warning">Image upload not yet implemented</div>';
});
</script>
{% endblock %}
